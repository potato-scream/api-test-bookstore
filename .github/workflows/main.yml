name: API Tests CI

on:
  push:
    branches: [ "main" ]

jobs:
  run-api-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check code style
        run: ./gradlew spotlessCheck

      - name: Run API tests
        run: ./gradlew test -Dlogin=${{ secrets.LOGIN }} -Dpassword=${{ secrets.PASSWORD }}

      - name: Setup Allure Commandline
        if: always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.tgz
          sudo tar -zxvf allure-2.21.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.21.0/bin/allure /usr/bin/allure
          allure --version

      - name: Generate Allure Report
        if: always()
        run: allure generate build/allure-results -o allure-report --clean

      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Parse Allure Summary
        if: always()
        id: allure_summary
        run: |
          TOTAL=$(jq '.statistic.total' allure-report/widgets/summary.json)
          PASSED=$(jq '.statistic.passed' allure-report/widgets/summary.json)
          DURATION_MS=$(jq '.time.duration' allure-report/widgets/summary.json)

          if [ "$TOTAL" -gt 0 ]; then
            PASS_PERCENTAGE=$((PASSED * 100 / TOTAL))
          else
            PASS_PERCENTAGE=0
          fi

          DURATION_S=$((DURATION_MS / 1000))
          MINUTES=$((DURATION_S / 60))
          SECONDS=$((DURATION_S % 60))
          FORMATTED_DURATION=$(printf "%02d:%02d" $MINUTES $SECONDS)

          echo "TOTAL_SCENARIOS=$TOTAL" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED" >> $GITHUB_ENV
          echo "PASS_PERCENTAGE=$PASS_PERCENTAGE" >> $GITHUB_ENV
          echo "TEST_DURATION=$FORMATTED_DURATION" >> $GITHUB_ENV

      - name: Send Telegram Notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            **${{ github.event.repository.name }}**
            ğŸ“Š **Build Status:** ${{ job.status }}
            ğŸ“¦ **Repository:** ${{ github.repository }}
            ğŸ“ **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            â±ï¸ **Duration:** ${{ env.TEST_DURATION }}
            ğŸ“ˆ **Total Scenarios:** ${{ env.TOTAL_SCENARIOS }}
            âœ… **Passed:** ${{ env.PASSED_TESTS }} (${{ env.PASS_PERCENTAGE }}%)

            ğŸš€ **Allure Report:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
