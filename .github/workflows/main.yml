# –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ CI/CD –ø—Ä–æ—Ü–µ—Å—Å–∞
name: API Tests CI

# –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É 'main'
on:
  push:
    branches: [ "main" ]

jobs:
  # –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
  run-api-tests:
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Ubuntu
    runs-on: ubuntu-latest

    # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
    permissions:
      contents: write

    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v3

      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Java 17
      # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java 17, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å 'record' –∏ –¥—Ä—É–≥–∏–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # –®–∞–≥ 3: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø—É—Å–∫ Gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run API tests
        run: ./gradlew test

      # –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure Commandline
      - name: Setup Allure Commandline
        if: always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.tgz
          sudo tar -zxvf allure-2.21.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.21.0/bin/allure /usr/bin/allure
          allure --version

      # –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML-–æ—Ç—á–µ—Ç–∞ Allure
      - name: Generate Allure Report
        if: always()
        run: allure generate build/allure-results -o allure-report --clean

      # –®–∞–≥ 7: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      # –®–∞–≥ 8: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
      - name: Send Telegram Notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üìä **–°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏:** ${{ job.status }}
            üì¶ **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** ${{ github.repository }}
            üìù **–ö–æ–º–º–∏—Ç:** https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            
            üöÄ **–û—Ç—á–µ—Ç Allure:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
